__author__ = 'Victor'
'''
Applies the reorder filter to an arff dataset
'''

from weka_utils.weka_cl.command import WekaCommand
import re
from os.path import join
from os import listdir

class ReorderCommand(WekaCommand):
    def __init__(self, heap='16g', cp=None):
        super(ReorderCommand, self).__init__(heap=heap, cp=cp)
    def set_source(self, source):
        self._source = source
    def set_output(self, out_path):
        self._output = out_path
    def set_order(self, feature_order):
        self._order = feature_order
    def order_by(self, criterion):
        self._order_by = criterion
    def command_trail(self):
        self.add2command(' -i ' + self._source + ' -o ' + self._output)

def arff_features(arff_path):
    '''
    extracts the feature names from an arff file
    :param arff_path: path to arff dataset
    :return:
    '''
    features = []
    with open(arff_path, 'r') as arff:
        for line in arff:
            if '@attribute' not in line and '@ATTRIBUTE' not in line:
                continue
            else:
                features += [re.split(r'\s+', line.strip())[1]]
                break
        for line in arff:
            if '@attribute' not in line and '@ATTRIBUTE' not in line:
                break
            else:
                features += [re.split(r'\s+', line.strip())[1]]
    return features

def get_index(value, in_list):
    '''
    Get index of an item in in_list with silent failure (return None if item not in list as opposed to raising error)
    :param value: value to look for in in_list
    :param in_list: input list
    :return: 0-based index (None if value not in in_list)
    '''
    try:
        index = in_list.index(value)
        return index
    except ValueError:
        return None

def name_mapping(source, order, index_base=1):
    '''
    Maps a feature order form names to indices according to the indices in a pre-existing arff dataset
    :param source: arff dataset
    :param order: desired attribute order (by name)
    :return: index-based order (to be used when applying the reorder filter)
    '''

    current_order = arff_features(arff_path=source)

    if index_base == 0:
        return [get_index(attr, current_order) for attr in order if get_index(attr, current_order)]
    elif index_base == 1:
        return [get_index(attr, current_order) + 1 for attr in order if get_index(attr, current_order)]
def reorder(arff_path, out_path, feature_order, order_by='Index', weka_cp='', heap='64g'):
    '''
    Applies the reorder filter to an arff dataset
    :param arff_path: path to source arff (the one to reorder)
    :param out_path: path to new arff dataset (ordered by feature_order)
    :param feature_order: the desired feature order
    :param order_by: whether feature_order is index-based or name-based
    :return: weka command to be executed
    '''
    cl = ReorderCommand(heap=heap, cp=weka_cp)
    cl.set_source(source=arff_path)
    cl.set_output(out_path=out_path)
    cl.set_order(feature_order=feature_order)
    cl.order_by(criterion=order_by)

    cl.add2command('weka.filters.unsupervised.attribute.Reorder -R ')

    if cl._order_by == 'Name':
        order = name_mapping(source=cl._source, order=cl._order)
        cl.add2command(','.join([str(attr) for attr in order]))
    elif order_by == 'Index':
        cl.add2command(cl._order)
    else:
        raise NameError('Invalid ordeing criterion')

    cl.command_trail()
    return cl

#demo
def main():
    arff_dir = '/Users/Victor/Desktop/ARFF/NLP/'
    arff_files = [f for f in listdir(arff_dir) if f.endswith('.arff')]

    desired_order = "C0392920|C0013216|C0733468|C0591139|C0004339|C0032181|C0518015|C0019046|C0024109|C0729502|C0003392|C0812987|C0681827|C0024228|C0497156|C0699319|C0015133|C0042679|C0012359|C0027627|C0000726|C2939419|C2939420|C0085752|C2936928|C0853697|C0234215|C0027947|C0029463|C0585442|C0040732|C1704313|C0221198|C0020823|C0523826|C0025677|C0577559|C0517391|C0030548|C2064719|C0206046|C0029216|C0026724|C0250482|C0234233|C1879316|C0518014|C0042313|C0026727|C0373675|C0025255|C0424637|C0036828|C0201836|C0578736|C0002170|C0023508|C0202178|C0005823|C0591971|C0201899|C0005558|C0202113|C0184921|C0018246|C0426663|C0035508|C0018808|C0008838|C0003297|C0201975|C0202035|C0201850|C0007226|C2229720|C1145640|C0202421|C0000294|C0005845|C0201913|C0005953|C0376152|C0000975|C0000979|C2004491|C0241158|C0202194|C0030049|C0015230|C0035203|C0201952|C0728940|C0019214|C0015252|C0368753|C0817096|C0240417|C0553580|C1261045|C0036992|C0027497|C0013089|C0337443|C0027819|C0700095|C0205054|C0591635|C1267547|C0230028|C0200949|C0000731|C0005954|C0023884|C1279061|C0036037|C0549207|C1269542|C1278910|C0424824|C0039476|C0034121|C0192796|C1096243|C0034642|C2183768|C0573980|C0023413|C0232498|C1320718|C0751378|C2721771|C0718244|C2316467|C0948762|C0055003|C1522449|C0746884|C0009555|C0030863|C1260880|C0200633|C0016277|C0578735|C0728755|C0004454|C0278694|C1135161|C0021852|C0235592|C1515974|C0454059|C1517033|C0026845|C0024204|C0519030|C0022727|C1835620|C0239110|C0286036|C0423615|C1319886|C0011991|C1171279|C0391850|C0235599|C0043229|C0201838|C1293861|C0008370|C0041582|C0702182|C2230237|C0202823|C0743903|C0023911|C0036656|C0203668|C0147020|C0231832|C0518766|C1828805|C0733521|C0016658|C0007559|C1656551|C0841647|C0034991|C1370196|C0277797|C0035412|C0524461|C1282864|C0027530|C0085494|C0005847|C1263440|C0042963|C0430022|C0023901|C0028741|C0425542|C0445625|C0015967|C0746922|C0032952|C1269647|C0007634|C0333355|C0079134|C1411966|C0018787|C0086143|C0021311|C0010583|C0578617|C0537894|C0006836|C0060282|C0373721|C1265570|C0302142|C0006840|C0078944|C0678176|C0175677|C0153676|C0038160|C0015733|C0038170|C0071304|C2143306|C0015620|C0007874|C0017066|C0074722|C0700004|C0043100|C0035139|C1512338|C0149744|C0523744|C0043144|C0013428|C1385369|C0746759|C0009014|C0425716|C0475091|C0041834|C0005961|C0699678|C0149745|C0722364|C1720053|C0240083|C0025605|C0430400|C0034079|C2242979|C0042066|C0036439|C0009806|C0085590|C0591953|C0079083|C0018810|C0728963|C0086818|C0201930|C0876088|C0202164|C0226896|C0368761|C1261360|C0238562|C0005821|C0231224|C1948071|C0003993|C0066005|C1822022|C0005841|C0018213|C0027540|C1334928|C0034977|C0678125|C0663241|C0023467|C0349636|C0232693|C0041657|C0023485|C1292769|C0010823|C0021853|C0011015|C0312839|C0010825|C1394508|C0002645|C2237655|C0011777|C0037268|C0748736|C0042961|C0373748|C0699194|C0265706|C1293896|C1718165|C1318441|C0029473|C0086252|C0002871|C0336598|C0231225|C0939711|C0004610|C0242073|C0013516|C0014344|C0087086|C0591076|C0030605|C0733854|C1403166|C0243066|C2076949|C0574032|C0015385|C0373587|C0373638|C0202054|C0442967|C0043246|C0150595|C0017196|C0019829|C0026649|C0175730|C0333516|C0700899|C1281553|C0020883|C0384963|C0439805|C1706406|C0020402|C0850979|C0199796|C0024299|C0193388|C0876139|C1170348|C1261473|C0740857|C1961102|C0678119|C0206624|C0038250|C1704783|C0423630|C0018956|C0742342|C0026946|C0016832|C0087163|C0007258|C0023992|C0814250|C0038218|C1442959|C1881358|C1014240|C0027708|C0005889|C0202059|C0028709|C0441516|C0028259|C0206655|C0742343|C0037473|C0393080|C0031150|C0242429|C0085704|C0023038|C0042044|C0010200|C0024477|C2034479|C0017725|C0000734|C0006413|C0221283|C0699992|C0559309|C0006271|C1302181|C2945801|C1269538|C0750138|C0728985|C0036983|C0008320|C0857127|C0525032|C0184269|C0065164|C0006826|C0201968|C0455900|C0034606|C0576890|C1123023|C0004609|C0162712|C0019080|C0085149|C0192700|C0490617|C0423797|C0574769|C1860137|C0344093|C0023895|C0040034|C0312738|C0022646|C0227665|C0542331|C1533281|C0210630|C0240962|C0040053|C0002895|C0149678|C0014644|C2349964|C0011880|C0018990|C0860204|C0202042|C1281182|C0017189|C0337438|C0033707|C0085639|C0005388|C0085405|C0199962|C2188753|C1550634|C2049621|C0014130|C0021079|C0005740|C0750879|C0746573|C0010711|C0262950|C0238425|C0022671|C0728727|C0204658|C0023449|C0060486|C0020538|C0187906|C0392885|C0558148|C0004096|C0876060|C0036410|C1320542|C0030252|C1335957|C0857121|C0592558|C1264633|C0202239|C0002793|C0349790|C0192616|C1445096|C1319813|C2752077|C0184613|C0699477|C0206161|C0002688|C0023222|C0863174|C0011878|C0031350|C0030247|C0000618|C0649061|C2228238|C0372525|C1268989|C0001625|C0027695|C0436125|C0001927|C2699973|C0696229|C0147814|C0232188|C0035335|C0424790|C0039231|C0003234|C0041445|C2029900|C0073385|C0000833|C0176996|C0582240|C0023448|C1261281|C0001699|C1268971|C0201916|C1320655|C0009274|C0521256|C1522662|C0080203|C0011854|C0002144|C0027765|C1765317|C1261317|C0162401|C0030232|C0185373|C0021081|C2826581|C1517560|C0153690|C1533591|C0011806|C0086140|C0724034|C0014591|C0022742|C0085602|C0239072|C1533577|C0720466|C0185023|C0016642|C0014245|C0282493|C0426466|C2370853|C0001511|C0221210|C1407081|C0040590|C0576742|C0085693|C1116531|C0107189|C0036025|C0043393|C1318442|C0159125|C0022346|C0019134|C0192407|C2004488|C0425586|C0266175|C0162119|C0079772|C0279980|C0699601|C1297886|C0719605|C0518864|C0740980|C0020268|C0175663|C0591132|C0024480|C0939412|C0851677|C2609068|C0151825|C0005411|C2235896|C0087153|C0302148|C0175751|C0558829|C0577045|C0876064|C0039870|C0032825|C2168219|C0008947|C0024202|C0424578|C0003962|C0020649|C0441610|C0192601|C0009938|C0014356|C0078257|C0448194|C0240225|C0054201|C0028734|C0152965|C0206743|C0270708|C1705509|C1511237|C0945826|C0085740|C0591054|C1140621|C0021831|C0523631|C0591130|C0745527|C0591320|C0011135|C0023418|C0153924|C0935987|C1278922|C0022378|C0012826|C0021885|C1269079|C0085297|C0206663|C0206093|C0520459|C0684337|C0178310|C0559769|C0528249|C0278779|C0206656|C0033117|C2931379|C0319899|C0030797|C0030354|C0596020|C0733823|C0162702|C0175662|C0004604|C1265175|C0006681|C0030842|C0220892|C0027358|C0543478|C0242596|C1280975|C2825146|C0014136|C0040128|C0016410|C0007554|C0719974|C0013819|C0033405|C0856536|C0023795|C1522411|C0883208|C0062185|C0230003|C0198488|C2126992|C1849208|C0032285|C0014392|C0019209|C0003615|C0021828|C0373595|C0718635|C0149521|C0037304|C0301571|C0342500|C0182537|C0008031|C0202691|C0347943|C0033045|C0347944|C0201539|C0031256|C0428405|C0523997|C0020255|C0123931|C1318087|C2825053|C0018780|C2937251|C2014145|C0016360|C0179686|C1510952|C0013144|C0003842|C2830004|C0314752|C0206651|C0033808|C0033817|C0392201|C0007561|C0445115|C1170609|C0006147|C0200382|C0701459|C0042105|C0231162|C0237403|C0720170|C0032743|C0008311|C0232257|C0591416|C1168198|C0018681|C1269888|C0019145|C0699315|C0017421|C0332655|C0040341|C0748404|C0052796|C0232602|C0746412|C0003611|C0722072|C0032617|C0546176|C0232139|C0180008|C2111427|C0517555|C1446561|C0517915|C0008479|C0038293|C0721347|C0231875|C0334488|C0346251|C0229473|C0373670|C0234222|C0523940|C0460139|C0151754|C0033774|C0146224|C0376562|C0030312|C0909381|C0038404|C0002692|C0018817|C0015811|C0029112|C0886287|C0004600|C0700148|C1265875|C0278512|C0019158|C0220650|C1328050|C0398523|C0393022|C0006625|C0740369|C1820738|C0239998|C0162817|C1401013|C0337308|C0494165|C0013595|C0430681|C1306459|C0349707|C0206637|C2202511|C0086787|C0181586|C0003469|C0598934|C0201883|C0008809|C0086444|C0006107|C0858814|C0373677|C2076953|C0860902|C0014834|C0031017|C1504389|C0005791|C0722365|C0202098|C0442867|C0225991|C2222799|C0412620|C0021641|C0029882|C2827407|C0457193|C0192499|C0857353|C0751651|C0020542|C1278932|C0037993|C0003617|C1269000|C0028429|C0430784|C0014145|C0241228|C0005790|C0564832|C0678215|C0042487|C0554990|C1278927|C0003461|C0456378|C0560495|C0019159|C0796548|C0278586|C0002691|C0587050|C0392386|C0682742|C0700292|C0702059|C0016059|C0025289|C0411265|C0006938|C0151317|C0002680|C1275397|C2095775|C0205875|C0851860|C0002625|C0860800|C0034194|C0221583|C0279622|C0260835|C0074757|C0075870|C1282845|C0204888|C0412628|C0021874|C0020578|C0001259|C0562238|C0028833|C1281590|C0229559|C0018670|C1281338|C2184260|C0006849|C0728750|C0000924|C1275402|C2184084|C0740057|C1269563|C0619485|C0577053|C0037786|C1281575|C0927232|C0241526|C0045093|C2051638|C0237284|C0240119|C1548802|C0037868|C0516979|C1821178|C0278713|C0227922|C0039194|C0025066|C0286079|C1278909|C0347941|C0004057|C0700926|C2017290|C0037580|C0085692|C0373585|C2076946|C0079748|C0019139|C0592075|C0038002|C1281552|C0015846|C0022377|C1857947|C0578150|C0002622|C1821769|C0036974|C0020541|C0232741|C1706307|C0587867|C0238339|C0000737|C0392006|C0749607|C0036277|C0032143|C0696098|C0202230|C0424657|C0022661|C0236053|C0026549|C0181331|C0178874|C0723950|C1279606|C0230443|C0279883|C0039991|C1335760|C0042749|C0577129|C0278714|C0189485|C0031734|C0202115|C1302752|C0580209|C0184922|C0005400|C0262581|C0487782|C0810430|C0870067|C0190693|C0858958|C1002306|C0035869|C0035870|C0043481|C0229664|C0749155|C0020889|C1279102|C0017422|C1281530|C1963704|C0010405|C0238806|C1531924|C0281268|C1096599|C1517677|C2184085|C1280090|C0017565|C0555179|C0579233|C0700297|C0152268|C0733688|C0239377|C0037995|C0043242|C0016641|C0920028|C1278903|C0734893|C0741614|C0239696|C0027543|C0699932|C0221247|C0051809|C0507205|C0024305|C0205707|C0031354|C0007570|C0700704|C1444861|C0017562|C1278912|C1565489|C1961099|C0225757|C0010692|C0030305|C0747199|C0162429|C0200955|C0947912|C0026896|C1280903|C0817320|C0700517|C0015258|C0205851|C0051760|C0085795|C1513183|C1285498|C0719222|C0559460|C1587981|C0376563|C1550647|C1278923|C0020885|C1141976|C0150077|C0018674|C0203145|C0278511|C0243065|C0679254|C0474527|C0022729|C0206180|C0240318|C0202100|C0745528|C0016167|C0014544|C1318464|C2185933|C0519952|C0430414|C0718566|C0430403|C1515933|C1440080|C0016546|C0149871|C0748483|C1570232|C0086395|C1821142|C0694675|C1701919|C0024205|C2939142|C0031955|C0444889|C0728762|C0015663|C1278905|C0040578|C0026639|C0015802|C0009952|C0042449|C0719199|C0042458|C1269024|C0216231|C0585059|C0035236|C2586122|C0883301|C0232462|C0400447|C0521491|C0277556|C0694547|C0234451|C1402869|C0509489|C1292758|C1402870|C0392106|C0086492|C0003308|C0151942|C0011946|C2316810|C0016542|C1299802|C0750164|C1281569|C0009368|C0060926|C0332575|C1397781|C0036429|C0281176|C0037763|C0723148|C0748986|C0334160|C0447541|C0015450|C2054233|C0188379|C0343138|C1881306|C0017797|C0033377|C0014378|C0014383|C0699967|C0748419|C1314782|C1514100|C0699702|C1336052|C0023903|C0262502|C1409727|C0005957|C1510483|C0234771|C0576994|C0334227|C0015672|C0285868|C0013491|C0302862|C0412594|C0079731|C0018965|C1280233|C2945579|C0222861|C0347788|C0278704|C2203183|C0701042|C0035359|C0742904|C0271429|C0241910|C0240322|C0424860|C0347636|C0230102|C0311276|C1522537|C0733470|C0751598|C0002199|C1116449|C0021747|C1305215|C0034272|C1535881|C0337358|C1705500|C1518999|C0422970|C0085635|C0849819|C0600139|C0376358|C0150055|C0016662|C0265269|C1305671|C0220836|READMITTED"
    desired_order = re.split(r'\|', desired_order)

    weka_cp = '/Users/Victor/"Box Sync"/DBMI/ResearchProject/weka3-7-10/weka.jar'

    for arff_file in arff_files:
        in_name = join(arff_dir, arff_file)
        out_name = join(arff_dir, arff_file[:-5] + '_reordered.arff')
        cl = reorder(arff_path=in_name, out_path=out_name, feature_order=desired_order, order_by='Name', weka_cp=weka_cp, heap='16g')
        cl.execute(verbose=True, shell=True)

if __name__ == '__main__':
    main()

